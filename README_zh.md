# XSS MiniFOC Project
[English Version](README.md)

## 1. 介绍
本工程提供一个简单、小尺寸和便宜的FOC PCB设计/方案。你能够在此设计上测试自己的FOC算法。这个设计的目的是作为四驱机器人小车每个电机的FOC驱动。
考虑到它的成本目标，我将选择STM32G0系列作为我的目标MCU。[NXP和Microchip的没有找到足够便宜的MCU。]这个版本，我将用STM32G070RBT6作为我的目标MCU。它拥有36K的RAM和128K的Flash。

一般情况下，这颗MCU的资源对于复杂的FOC来说是有限的。但是对于简单的FOC应用，应当是足够的。我最初想设计一款带有CAN或者CAN FD总线接口的FOC板卡。然后最终选择的这颗MCU并没有这个接口。STM32G0B1可能更合适。下一更大尺寸的版本我可能会考虑使用STM32G0B1或者STM32G431.但是这两者都很贵。对于一个小尺寸的板子来说，CAN收发器电路将占据比较大的尺寸。RX232/485也有相同问题。如果我想将对各MiniFOC板子连接到主控制器,我就必须找到一种将它们级联起来的方式。因此我将使用SPI雏菊链的方式去实现它。I2C也可以将多个节点连接起来。但是我不喜欢I2C因为它总是很容易产生死锁问题。关于SPI雏菊链的解法可以参见[ADI的《SPI器件的菊链配置》](https://www.analog.com/cn/technical-articles/daisychaining-spi-devices.html).

考虑到我已经获取的无刷减速电机，我将这个板子的目标电压定在24V。最大电流可以考虑是2.5A，因为目前容易获取的便宜的BLDC电机都低于2A。

## 2. 硬件选型
这个FOC板卡将提供BLDC/PMSM电机的UVW接口，霍尔传感器接口。并在板子上集成一个磁编码器。板子的尺寸将根据我选择的无刷直流减速电机来确定。但是基于相同的原理，你可以设计其它尺寸的板卡。

### 2.1 无刷减速电机
目前手边采购到的无刷减速电机是优必选CRUZR机器人上面的手臂电机。但是目前暂时不知道减速比。<font color='red'>之后拆解减速器之后再计算。</font>
目前了解到电机采用郎亿2835RB-01A电机。额定转速11270RPM，额定电流1A。额定电压24V。电机有两簇线：一簇为UVW的电机线，另一簇为霍尔线（另含一根NTC电阻线）。

### 2.2 MCU
MCU第一版准备使用手边已经采购的STM32G070RBT6（10mmx10mm），如果尺寸较大不排除使用另一款芯片STM32G070CBT6（7mmx7mm）。
这款芯片有36K SRAM和128K Flash。ADC只有一路（如果有两路，则可以保证对两路模拟通道的同时采样），否则只能分时轮流采集。[注：G431有多路ADC，配置得当，可以三路同时采集。所以对于更专业的FOC可以考虑使用G431等更先进的芯片。]
为了能够实现FOC，首要的一步就是采集UVW三相的电流。通常的做法是在三个半桥的下桥臂连接采样电阻。然后通过运放将采样电阻两端的电压放大之后输出给ADC转换。这款MCU内部并不携带运放，所以若采用三电阻采样则需要三路运放。当然也可以使用单电阻方案。但是单电阻采样也有自己的一些难点。

### 2.3 磁编码器
目前选择的无刷减速电机本身输出轴上安装有一个3mm直径的径向充磁的磁铁。本身还带有一个老款的MPS的磁编码器芯片MP9960GQ-Z。但是因为电机自带的板子上的连线不方便测量，最主要是暂时没有找到这款芯片的资料。所以还是准备再MiniFOC上自行设计一个磁编码器。用户最长选择用的是带I2C接口的AS5600。但是考虑到TLE5012B精度更高，价格也OK。所以想尝试一下这一款磁编码器。

### 2.4 电机驱动芯片
目前备选的芯片有DRV8313（比较常用），MP6536和MP6540（或者MP6540H）。其实里面比较理想的是MP6540H，但是这一款芯片不太容易获取。MP6536的价格最低，应该会采购此芯片。MP6540的引脚比较适合layout，价格适中,但是电流是三者中最小的。DRV8313最贵。目前这一版首选的MP6536.

### 2.5 电源设计
为了减小MiniFOC的面积，尽可能的减少上面的元件。所以板子上不设计DC转DC的部分，而是从外部分别引入电机电源和5V电源。板子上流出LDO电路，有5V作为数字部分的主电源，经过LDO转换为3.3V后供其它部分使用。

### 2.6 电流检测
电流检测通常有两种做法来实现，一种是使用现成的电流传感器，另一种是使用运放，常用专门的电流检测放大器（运放的一种）。目前看来电流检测放大器是一种比较好的方案。TI的INA180/181系列，思瑞浦的TP181系列都是价格比较合适的产品。
但是若选择使用三路采样，价格依然比较昂贵。单路电流采样是最好的方案。
通常情况下还应该对母线电流进行监控以防止过流问题。

### 2.7 接口
考虑到线路简洁，MiniFOC节点之间的通讯电路通过级联方式。也就是每块板子上既有进也有出。电机电源这考虑由主电源分别给每个节点供电，防止级联损耗。
级联的数字信号由SPI的CS，SCK，SPI或SPO，以及5V电源组成。考虑使用PHB接口的双排贴片插座。
电机提供的两组线分别由XH-3P的接头和MX-6P的接头。所以板子上需要流出相应的接头。
电机电源可考虑KF250系列或者VH3.96系列接插件。

## 3. 主从节点通讯
### 3.1 SPI雏菊链的优势和缺陷

### 3.2 SPI多主通讯

### 3.3 SPI带地址通讯


